{"version":3,"sources":["node_modules/browser-pack/_prelude.js","context-service.js","node_modules/runtime-core/src/bus/Bus.js","node_modules/runtime-core/src/bus/MiniBus.js","node_modules/runtime-core/src/sandbox/Sandbox.js","node_modules/runtime-core/src/sandbox/SandboxRegistry.js","src/ContextServiceProvider.js"],"names":["f","exports","module","define","amd","g","window","global","self","this","contextService","e","t","n","r","s","o","u","a","require","i","Error","code","l","call","length",1,"_classCallCheck","instance","Constructor","TypeError","Object","defineProperty","value","_createClass","defineProperties","target","props","descriptor","enumerable","configurable","writable","key","protoProps","staticProps","prototype","Bus","_this","_msgId","_subscriptions","_responseTimeOut","_responseCallbacks","_registerExternalListener","url","listener","item","MsgListener","itemList","push","msgId","responseListener","outUrl","inUrl","_this2","thisListn","addListener","msg","postMessage","targetListn","thisListener","targetListener","unbind","remove","_publishOn","forEach","sub","_callback","inMsg","responseCallback","responseId","from","id","setTimeout","responseFun","errorMsg","type","body","desc","to","_onResponse","_publishOnDefault","subscriptions","callback","_url","subs","index","indexOf","splice","get",2,"_interopRequireDefault","obj","__esModule","default","_possibleConstructorReturn","ReferenceError","_inherits","subClass","superClass","create","constructor","setPrototypeOf","__proto__","_Bus2","_Bus3","MiniBus","_Bus","getPrototypeOf","_genId","_responseCallback","_onPostMessage","startsWith","./Bus",3,"SandboxType","undefined","_SandboxRegistry","_SandboxRegistry2","_MiniBus2","_MiniBus3","Sandbox","APP","NORMAL","_MiniBus","componentSourceCode","componentURL","configuration","Promise","resolve","reject","deployMessage","ExternalDeployAddress","InternalDeployAddress","sourceCode","config","reply","removeMessage","../bus/MiniBus","../sandbox/SandboxRegistry",4,"SandboxRegistry","bus","_bus","_components","_onDeploy","_onRemove","responseMsg","responseCode","responseDesc","hasOwnProperty","_create","error","_responseMsg","removeAllListenersOf",5,"_Sandbox","_miniBus","addEventListener","event","_onMessage","data","_registry","eval","apply","activate","runtime-core/src/bus/MiniBus","runtime-core/src/sandbox/Sandbox","runtime-core/src/sandbox/SandboxRegistry"],"mappings":"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","file":"context-service.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.contextService = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/**\n* @author micaelpedrosa@gmail.com\n* Minimal interface and implementation to send and receive messages. It can be reused in many type of components.\n* Components that need a message system should receive this class as a dependency or extend it.\n* Extensions should implement the following private methods: _onPostMessage and _registerExternalListener\n*/\n\nvar Bus = function () {\n  /* private\n  _msgId: number;\n  _subscriptions: <url: MsgListener[]>\n   _responseTimeOut: number\n  _responseCallbacks: <url+id: (msg) => void>\n   */\n\n  function Bus() {\n    _classCallCheck(this, Bus);\n\n    var _this = this;\n    _this._msgId = 0;\n    _this._subscriptions = {};\n\n    _this._responseTimeOut = 5000; //default to 3s\n    _this._responseCallbacks = {};\n\n    _this._registerExternalListener();\n  }\n\n  /**\n  * Register listener to receive message when \"msg.to === url\".\n  * Special url \"*\" for default listener is accepted to intercept all messages.\n  * @param {URL} url Address to intercept, tha is in the message \"to\"\n  * @param {Listener} listener listener\n  * @return {MsgListener} instance of MsgListener\n  */\n\n\n  _createClass(Bus, [{\n    key: 'addListener',\n    value: function addListener(url, listener) {\n      var _this = this;\n\n      var item = new MsgListener(_this._subscriptions, url, listener);\n      var itemList = _this._subscriptions[url];\n      if (!itemList) {\n        itemList = [];\n        _this._subscriptions[url] = itemList;\n      }\n\n      itemList.push(item);\n      return item;\n    }\n\n    /**\n     * Manually add a response listener. Only one listener per message ID should exist.\n     * ATENTION, there is no timeout for this listener.\n     * The listener should be removed with a removeResponseListener, failing to do this will result in a unreleased memory problem.\n     * @param {URL} url Origin address of the message sent, \"msg.from\".\n     * @param {number} msgId Message ID that is returned from the postMessage.\n     * @param {Function} responseListener Callback function for the response\n     */\n\n  }, {\n    key: 'addResponseListener',\n    value: function addResponseListener(url, msgId, responseListener) {\n      this._responseCallbacks[url + msgId] = responseListener;\n    }\n\n    /**\n     * Remove the response listener.\n     * @param {URL} url Origin address of the message sent, \"msg.from\".\n     * @param {number} msgId  Message ID that is returned from the postMessage\n     */\n\n  }, {\n    key: 'removeResponseListener',\n    value: function removeResponseListener(url, msgId) {\n      delete this._responseCallbacks[url + msgId];\n    }\n\n    /**\n     * Remove all existent listeners for the URL\n     * @param  {URL} url Address registered\n     */\n\n  }, {\n    key: 'removeAllListenersOf',\n    value: function removeAllListenersOf(url) {\n      delete this._subscriptions[url];\n    }\n\n    /**\n     * Helper method to bind listeners (in both directions) into other MiniBus target.\n     * @param  {URL} outUrl Outbound URL, register listener for url in direction \"this -> target\"\n     * @param  {URL} inUrl Inbound URL, register listener for url in direction \"target -> this\"\n     * @param  {MiniBus} target The other target MiniBus\n     * @return {Bound} an object that contains the properties [thisListener, targetListener] and the unbind method.\n     */\n\n  }, {\n    key: 'bind',\n    value: function bind(outUrl, inUrl, target) {\n      var _this2 = this;\n\n      var _this = this;\n\n      var thisListn = _this.addListener(outUrl, function (msg) {\n        target.postMessage(msg);\n      });\n\n      var targetListn = target.addListener(inUrl, function (msg) {\n        _this.postMessage(msg);\n      });\n\n      return {\n        thisListener: thisListn,\n        targetListener: targetListn,\n        unbind: function unbind() {\n          _this2.thisListener.remove();\n          _this2.targetListener.remove();\n        }\n      };\n    }\n\n    //publish on default listeners\n\n  }, {\n    key: '_publishOnDefault',\n    value: function _publishOnDefault(msg) {\n      //is there any \"*\" (default) listeners?\n      var itemList = this._subscriptions['*'];\n      if (itemList) {\n        this._publishOn(itemList, msg);\n      }\n    }\n\n    //publish on a subscription list.\n\n  }, {\n    key: '_publishOn',\n    value: function _publishOn(itemList, msg) {\n      itemList.forEach(function (sub) {\n        sub._callback(msg);\n      });\n    }\n  }, {\n    key: '_responseCallback',\n    value: function _responseCallback(inMsg, responseCallback) {\n      var _this = this;\n\n      //automatic management of response handlers\n      if (responseCallback) {\n        (function () {\n          var responseId = inMsg.from + inMsg.id;\n          _this._responseCallbacks[responseId] = responseCallback;\n\n          setTimeout(function () {\n            var responseFun = _this._responseCallbacks[responseId];\n            delete _this._responseCallbacks[responseId];\n\n            if (responseFun) {\n              var errorMsg = {\n                id: inMsg.id, type: 'response',\n                body: { code: 408, desc: 'Response timeout!', value: inMsg }\n              };\n\n              responseFun(errorMsg);\n            }\n          }, _this._responseTimeOut);\n        })();\n      }\n    }\n  }, {\n    key: '_onResponse',\n    value: function _onResponse(msg) {\n      var _this = this;\n\n      if (msg.type === 'response') {\n        var responseId = msg.to + msg.id;\n        var responseFun = _this._responseCallbacks[responseId];\n\n        //if it's a provisional response, don't delete response listener\n        if (msg.body.code >= 200) {\n          delete _this._responseCallbacks[responseId];\n        }\n\n        if (responseFun) {\n          responseFun(msg);\n          return true;\n        }\n      }\n\n      return false;\n    }\n\n    //receive messages from external interface\n\n  }, {\n    key: '_onMessage',\n    value: function _onMessage(msg) {\n      var _this = this;\n\n      if (!_this._onResponse(msg)) {\n        var itemList = _this._subscriptions[msg.to];\n        if (itemList) {\n          _this._publishOn(itemList, msg);\n        } else {\n          _this._publishOnDefault(msg);\n        }\n      }\n    }\n  }, {\n    key: '_genId',\n    value: function _genId(inMsg) {\n      //TODO: how do we manage message ID's? Should it be a global runtime counter, or per URL address?\n      //Global counter will not work, because there will be multiple MiniBus instances!\n      //Per URL, can be a lot of data to maintain!\n      //Maybe a counter per MiniBus instance. This is the assumed solution for now.\n      if (!inMsg.id || inMsg.id === 0) {\n        this._msgId++;\n        inMsg.id = this._msgId;\n      }\n    }\n\n    /**\n    * Send messages to local listeners, or if not exists to external listeners.\n    * It's has an optional mechanism for automatic management of response handlers.\n    * The response handler will be unregistered after receiving the response, or after response timeout (default to 3s).\n    * @param  {Message} msg Message to send. Message ID is automatically added to the message.\n    * @param  {Function} responseCallback Optional parameter, if the developer what's automatic response management.\n    * @return {number} Returns the message ID, in case it should be needed for manual management of the response handler.\n    */\n\n  }, {\n    key: 'postMessage',\n    value: function postMessage(inMsg, responseCallback) {}\n\n    /**\n     * Not public available, used by the class extension implementation, to process messages from the public \"postMessage\" without a registered listener.\n     * Used to send the message to an external interface, like a WebWorker, IFrame, etc.\n     * @param  {Message.Message} msg Message\n     */\n\n  }, {\n    key: '_onPostMessage',\n    value: function _onPostMessage(msg) {} /*implementation will send message to external system*/\n\n    /**\n     * Not public available, used by the class extension implementation, to process all messages that enter the MiniBus from an external interface, like a WebWorker, IFrame, etc.\n     * This method is called one time in the constructor to register external listeners.\n     * The implementation will probably call the \"_onMessage\" method to publish in the local listeners.\n     * DO NOT call \"postMessage\", there is a danger that the message enters in a cycle!\n     */\n\n  }, {\n    key: '_registerExternalListener',\n    value: function _registerExternalListener() {/*implementation will register external listener and call \"this._onMessage(msg)\" */}\n  }]);\n\n  return Bus;\n}();\n\nvar MsgListener = function () {\n  /* private\n  _subscriptions: <string: MsgListener[]>;\n  _url: string;\n  _callback: (msg) => void;\n  */\n\n  function MsgListener(subscriptions, url, callback) {\n    _classCallCheck(this, MsgListener);\n\n    var _this = this;\n\n    _this._subscriptions = subscriptions;\n    _this._url = url;\n    _this._callback = callback;\n  }\n\n  _createClass(MsgListener, [{\n    key: 'remove',\n    value: function remove() {\n      var _this = this;\n\n      var subs = _this._subscriptions[_this._url];\n      if (subs) {\n        var index = subs.indexOf(_this);\n        subs.splice(index, 1);\n\n        //if there are no listeners, remove the subscription entirely.\n        if (subs.length === 0) {\n          delete _this._subscriptions[_this._url];\n        }\n      }\n    }\n  }, {\n    key: 'url',\n    get: function get() {\n      return this._url;\n    }\n  }]);\n\n  return MsgListener;\n}();\n\nexports.default = Bus;\n\n},{}],2:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _Bus2 = require('./Bus');\n\nvar _Bus3 = _interopRequireDefault(_Bus2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nvar MiniBus = function (_Bus) {\n  _inherits(MiniBus, _Bus);\n\n  function MiniBus() {\n    _classCallCheck(this, MiniBus);\n\n    return _possibleConstructorReturn(this, Object.getPrototypeOf(MiniBus).call(this));\n  }\n\n  _createClass(MiniBus, [{\n    key: 'postMessage',\n    value: function postMessage(inMsg, responseCallback) {\n      var _this = this;\n\n      _this._genId(inMsg);\n      _this._responseCallback(inMsg, responseCallback);\n\n      //always send to external (to core MessageBus)\n      _this._onPostMessage(inMsg);\n\n      return inMsg.id;\n    }\n  }, {\n    key: '_onMessage',\n    value: function _onMessage(msg) {\n      var _this = this;\n\n      if (!_this._onResponse(msg)) {\n        var itemList = _this._subscriptions[msg.to];\n        if (itemList) {\n          _this._publishOn(itemList, msg);\n          if (!msg.to.startsWith('hyperty')) {\n            _this._publishOnDefault(msg);\n          }\n        } else {\n          _this._publishOnDefault(msg);\n        }\n      }\n    }\n  }]);\n\n  return MiniBus;\n}(_Bus3.default);\n\nexports.default = MiniBus;\n\n},{\"./Bus\":1}],3:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SandboxType = undefined;\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nvar _SandboxRegistry = require('../sandbox/SandboxRegistry');\n\nvar _SandboxRegistry2 = _interopRequireDefault(_SandboxRegistry);\n\nvar _MiniBus2 = require('../bus/MiniBus');\n\nvar _MiniBus3 = _interopRequireDefault(_MiniBus2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\n// import MessageFactory from '../../resources/MessageFactory';\n\nvar SandboxType = exports.SandboxType = { APP: 'app', NORMAL: 'normal' };\n\n/**\n * @author micaelpedrosa@gmail.com\n * Base class to implement external sandbox component\n */\n\nvar Sandbox = function (_MiniBus) {\n  _inherits(Sandbox, _MiniBus);\n\n  function Sandbox() {\n    _classCallCheck(this, Sandbox);\n\n    var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(Sandbox).call(this));\n\n    var _this = _this2;\n\n    // Add Message Factory\n    // let messageFactory = new MessageFactory();\n    // _this.messageFactory = messageFactory;\n    return _this2;\n  }\n\n  /**\n   * Deploy an instance of the component into the sandbox.\n   * @param  {string} componentSourceCode Component source code (Hyperty, ProtoStub, etc)\n   * @param  {URL} componentURL Hyperty, ProtoStub, or any other component address.\n   * @param  {Config} configuration Config parameters of the component\n   * @return {Promise<string>} return deployed if successful, or any other string with an error\n   */\n\n\n  _createClass(Sandbox, [{\n    key: 'deployComponent',\n    value: function deployComponent(componentSourceCode, componentURL, configuration) {\n\n      var _this = this;\n\n      // let messageFactory = _this.messageFactory;\n\n      return new Promise(function (resolve, reject) {\n        //TODO: message format is not properly defined yet\n        var deployMessage = {\n          type: 'create', from: _SandboxRegistry2.default.ExternalDeployAddress, to: _SandboxRegistry2.default.InternalDeployAddress,\n          body: { url: componentURL, sourceCode: componentSourceCode, config: configuration }\n        };\n\n        //send message into the sandbox internals and wait for reply\n        _this.postMessage(deployMessage, function (reply) {\n          if (reply.body.code === 200) {\n            //is this response complaint with the spec?\n            resolve('deployed');\n          } else {\n            reject(reply.body.desc);\n          }\n        });\n      });\n    }\n\n    /**\n     * Remove the instance of a previously deployed component.\n     * @param  {URL} componentURL Hyperty, ProtoStub, or any other component address.\n     * @return {Promise<string>} return undeployed if successful, or any other string with an error\n     */\n\n  }, {\n    key: 'removeComponent',\n    value: function removeComponent(componentURL) {\n      var _this = this;\n\n      return new Promise(function (resolve, reject) {\n        //TODO: message format is not properly defined yet\n        var removeMessage = {\n          type: 'delete', from: _SandboxRegistry2.default.ExternalDeployAddress, to: _SandboxRegistry2.default.InternalDeployAddress,\n          body: { url: componentURL }\n        };\n\n        //send message into the sandbox internals and wait for reply\n        _this.postMessage(removeMessage, function (reply) {\n          if (reply.body.code === 200) {\n            //is this response complaint with the spec?\n            resolve('undeployed');\n          } else {\n            reject(reply.body.desc);\n          }\n        });\n      });\n    }\n  }]);\n\n  return Sandbox;\n}(_MiniBus3.default);\n\nexports.default = Sandbox;\n\n},{\"../bus/MiniBus\":2,\"../sandbox/SandboxRegistry\":4}],4:[function(require,module,exports){\n'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n/**\n * @author micaelpedrosa@gmail.com\n * Base class to implement internal deploy manager of components.\n */\n\n// import MessageFactory from '../../resources/MessageFactory';\n\nvar SandboxRegistry = function () {\n  /* private\n  _components: <url: instance>\n  */\n\n  function SandboxRegistry(bus) {\n    _classCallCheck(this, SandboxRegistry);\n\n    var _this = this;\n\n    _this._bus = bus;\n    _this._components = {};\n\n    // Add Message Factory\n    // let messageFactory = new MessageFactory();\n    // _this.messageFactory = messageFactory;\n\n    bus.addListener(SandboxRegistry.InternalDeployAddress, function (msg) {\n      //console.log('SandboxRegistry-RCV: ', msg);\n      // let responseMsg = {\n      //   id: msg.id, type: 'response', from: SandboxRegistry.InternalDeployAddress, to: SandboxRegistry.ExternalDeployAddress\n      // };\n\n      switch (msg.type) {\n        case 'create':\n          _this._onDeploy(msg);break;\n        case 'delete':\n          _this._onRemove(msg);break;\n      }\n    });\n  }\n\n  _createClass(SandboxRegistry, [{\n    key: '_responseMsg',\n    value: function _responseMsg(msg, code, value) {\n\n      var _this = this;\n\n      // let messageFactory = _this.messageFactory;\n\n      var responseMsg = {\n        id: msg.id, type: 'response', from: SandboxRegistry.InternalDeployAddress, to: SandboxRegistry.ExternalDeployAddress\n      };\n\n      // Chanege the origin message, because the response;\n      // msg.from = SandboxRegistry.InternalDeployAddress;\n      // msg.to = SandboxRegistry.ExternalDeployAddress;\n\n      var body = {};\n      if (code) body.code = code;\n      if (value) body.desc = value;\n\n      responseMsg.body = body;\n\n      // return messageFactory.createResponse(msg, code, value);\n      return responseMsg;\n    }\n  }, {\n    key: '_onDeploy',\n    value: function _onDeploy(msg) {\n      var _this = this;\n      var config = msg.body.config;\n      var componentURL = msg.body.url;\n      var sourceCode = msg.body.sourceCode;\n      var responseCode = void 0;\n      var responseDesc = void 0;\n\n      if (!_this._components.hasOwnProperty(componentURL)) {\n        try {\n          _this._components[componentURL] = _this._create(componentURL, sourceCode, config);\n          responseCode = 200;\n        } catch (error) {\n          responseCode = 500;\n          responseDesc = error;\n        }\n      } else {\n        responseCode = 500;\n        responseDesc = 'Instance ' + componentURL + ' already exist!';\n      }\n\n      // Create response message with MessageFactory\n      var responseMsg = _this._responseMsg(msg, responseCode, responseDesc);\n      _this._bus.postMessage(responseMsg);\n    }\n  }, {\n    key: '_onRemove',\n    value: function _onRemove(msg) {\n      var _this = this;\n      var componentURL = msg.body.url;\n      var responseCode = void 0;\n      var responseDesc = void 0;\n\n      if (_this._components.hasOwnProperty(componentURL)) {\n        //remove component from the pool and all listeners\n        delete _this._components[componentURL];\n        _this._bus.removeAllListenersOf(componentURL);\n        responseCode = 200;\n      } else {\n        responseCode = 500;\n        responseDesc = 'Instance ' + componentURL + ' doesn\\'t exist!';\n      }\n\n      var responseMsg = _this._responseMsg(msg, responseCode, responseDesc);\n\n      _this._bus.postMessage(responseMsg);\n    }\n\n    /**\n     * This method should be implemented by the internal sandbox code.\n     * @param  {ComponentURL} url URL used for the instance\n     * @param  {string} sourceCode Code of the component\n     * @param  {Config} config Configuration parameters\n     * @return {Object} Returns instance of the component or throw an error \"throw 'error message'\"\n     */\n\n  }, {\n    key: '_create',\n    value: function _create(url, sourceCode, config) {\n      //implementation specific\n      /* example code:\n        eval(sourceCode);\n        return activate(url, _this._bus, config);\n      */\n    }\n  }, {\n    key: 'components',\n    get: function get() {\n      return this._components;\n    }\n  }]);\n\n  return SandboxRegistry;\n}();\n\nSandboxRegistry.ExternalDeployAddress = 'hyperty-runtime://sandbox/external';\nSandboxRegistry.InternalDeployAddress = 'hyperty-runtime://sandbox/internal';\n\nexports.default = SandboxRegistry;\n\n},{}],5:[function(require,module,exports){\n'use strict';\n\nvar _Sandbox = require('runtime-core/src/sandbox/Sandbox');\n\nvar _Sandbox2 = _interopRequireDefault(_Sandbox);\n\nvar _SandboxRegistry = require('runtime-core/src/sandbox/SandboxRegistry');\n\nvar _SandboxRegistry2 = _interopRequireDefault(_SandboxRegistry);\n\nvar _MiniBus = require('runtime-core/src/bus/MiniBus');\n\nvar _MiniBus2 = _interopRequireDefault(_MiniBus);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nself._miniBus = new _MiniBus2.default(); /**\n                                         * Copyright 2016 PT Inovação e Sistemas SA\n                                         * Copyright 2016 INESC-ID\n                                         * Copyright 2016 QUOBIS NETWORKS SL\n                                         * Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V\n                                         * Copyright 2016 ORANGE SA\n                                         * Copyright 2016 Deutsche Telekom AG\n                                         * Copyright 2016 Apizee\n                                         * Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN\n                                         *\n                                         * Licensed under the Apache License, Version 2.0 (the \"License\");\n                                         * you may not use this file except in compliance with the License.\n                                         * You may obtain a copy of the License at\n                                         *\n                                         *   http://www.apache.org/licenses/LICENSE-2.0\n                                         *\n                                         * Unless required by applicable law or agreed to in writing, software\n                                         * distributed under the License is distributed on an \"AS IS\" BASIS,\n                                         * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n                                         * See the License for the specific language governing permissions and\n                                         * limitations under the License.\n                                         **/\n\nself._miniBus._onPostMessage = function (msg) {\n    self.postMessage(msg);\n};\nself.addEventListener('message', function (event) {\n    self._miniBus._onMessage(event.data);\n});\n\nself._registry = new _SandboxRegistry2.default(self._miniBus);\nself._registry._create = function (url, sourceCode, config) {\n    eval.apply(self, [sourceCode]);\n    return activate(url, self._miniBus, config);\n};\n\n},{\"runtime-core/src/bus/MiniBus\":2,\"runtime-core/src/sandbox/Sandbox\":3,\"runtime-core/src/sandbox/SandboxRegistry\":4}]},{},[5])(5)\n});\n\n","/**\n* @author micaelpedrosa@gmail.com\n* Minimal interface and implementation to send and receive messages. It can be reused in many type of components.\n* Components that need a message system should receive this class as a dependency or extend it.\n* Extensions should implement the following private methods: _onPostMessage and _registerExternalListener\n*/\nclass Bus {\n  /* private\n  _msgId: number;\n  _subscriptions: <url: MsgListener[]>\n\n  _responseTimeOut: number\n  _responseCallbacks: <url+id: (msg) => void>\n\n  */\n\n  constructor() {\n    let _this = this;\n    _this._msgId = 0;\n    _this._subscriptions = {};\n\n    _this._responseTimeOut = 5000; //default to 3s\n    _this._responseCallbacks = {};\n\n    _this._registerExternalListener();\n  }\n\n  /**\n  * Register listener to receive message when \"msg.to === url\".\n  * Special url \"*\" for default listener is accepted to intercept all messages.\n  * @param {URL} url Address to intercept, tha is in the message \"to\"\n  * @param {Listener} listener listener\n  * @return {MsgListener} instance of MsgListener\n  */\n  addListener(url, listener) {\n    let _this = this;\n\n    let item = new MsgListener(_this._subscriptions, url, listener);\n    let itemList = _this._subscriptions[url];\n    if (!itemList) {\n      itemList = [];\n      _this._subscriptions[url] = itemList;\n    }\n\n    itemList.push(item);\n    return item;\n  }\n\n  /**\n   * Manually add a response listener. Only one listener per message ID should exist.\n   * ATENTION, there is no timeout for this listener.\n   * The listener should be removed with a removeResponseListener, failing to do this will result in a unreleased memory problem.\n   * @param {URL} url Origin address of the message sent, \"msg.from\".\n   * @param {number} msgId Message ID that is returned from the postMessage.\n   * @param {Function} responseListener Callback function for the response\n   */\n  addResponseListener(url, msgId, responseListener) {\n    this._responseCallbacks[url + msgId] = responseListener;\n  }\n\n  /**\n   * Remove the response listener.\n   * @param {URL} url Origin address of the message sent, \"msg.from\".\n   * @param {number} msgId  Message ID that is returned from the postMessage\n   */\n  removeResponseListener(url, msgId) {\n    delete this._responseCallbacks[url + msgId];\n  }\n\n  /**\n   * Remove all existent listeners for the URL\n   * @param  {URL} url Address registered\n   */\n  removeAllListenersOf(url) {\n    delete this._subscriptions[url];\n  }\n\n  /**\n   * Helper method to bind listeners (in both directions) into other MiniBus target.\n   * @param  {URL} outUrl Outbound URL, register listener for url in direction \"this -> target\"\n   * @param  {URL} inUrl Inbound URL, register listener for url in direction \"target -> this\"\n   * @param  {MiniBus} target The other target MiniBus\n   * @return {Bound} an object that contains the properties [thisListener, targetListener] and the unbind method.\n   */\n  bind(outUrl, inUrl, target) {\n    let _this = this;\n\n    let thisListn = _this.addListener(outUrl, (msg) => {\n      target.postMessage(msg);\n    });\n\n    let targetListn = target.addListener(inUrl, (msg) => {\n      _this.postMessage(msg);\n    });\n\n    return {\n      thisListener: thisListn,\n      targetListener: targetListn,\n      unbind: () => {\n        this.thisListener.remove();\n        this.targetListener.remove();\n      }\n    };\n  }\n\n  //publish on default listeners\n  _publishOnDefault(msg) {\n    //is there any \"*\" (default) listeners?\n    let itemList = this._subscriptions['*'];\n    if (itemList) {\n      this._publishOn(itemList, msg);\n    }\n  }\n\n  //publish on a subscription list.\n  _publishOn(itemList, msg) {\n    itemList.forEach((sub) => {\n      sub._callback(msg);\n    });\n  }\n\n  _responseCallback(inMsg, responseCallback) {\n    let _this = this;\n\n    //automatic management of response handlers\n    if (responseCallback) {\n      let responseId = inMsg.from + inMsg.id;\n      _this._responseCallbacks[responseId] = responseCallback;\n\n      setTimeout(() => {\n        let responseFun = _this._responseCallbacks[responseId];\n        delete _this._responseCallbacks[responseId];\n\n        if (responseFun) {\n          let errorMsg = {\n            id: inMsg.id, type: 'response',\n            body: { code: 408, desc: 'Response timeout!', value: inMsg }\n          };\n\n          responseFun(errorMsg);\n        }\n      }, _this._responseTimeOut);\n    }\n  }\n\n  _onResponse(msg) {\n    let _this = this;\n\n    if (msg.type === 'response') {\n      let responseId = msg.to + msg.id;\n      let responseFun = _this._responseCallbacks[responseId];\n\n      //if it's a provisional response, don't delete response listener\n      if (msg.body.code >= 200) {\n        delete _this._responseCallbacks[responseId];\n      }\n\n      if (responseFun) {\n        responseFun(msg);\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  //receive messages from external interface\n  _onMessage(msg) {\n    let _this = this;\n\n    if (!_this._onResponse(msg)) {\n      let itemList = _this._subscriptions[msg.to];\n      if (itemList) {\n        _this._publishOn(itemList, msg);\n      } else {\n        _this._publishOnDefault(msg);\n      }\n    }\n  }\n\n  _genId(inMsg) {\n    //TODO: how do we manage message ID's? Should it be a global runtime counter, or per URL address?\n    //Global counter will not work, because there will be multiple MiniBus instances!\n    //Per URL, can be a lot of data to maintain!\n    //Maybe a counter per MiniBus instance. This is the assumed solution for now.\n    if (!inMsg.id || inMsg.id === 0) {\n      this._msgId++;\n      inMsg.id = this._msgId;\n    }\n  }\n\n  /**\n  * Send messages to local listeners, or if not exists to external listeners.\n  * It's has an optional mechanism for automatic management of response handlers.\n  * The response handler will be unregistered after receiving the response, or after response timeout (default to 3s).\n  * @param  {Message} msg Message to send. Message ID is automatically added to the message.\n  * @param  {Function} responseCallback Optional parameter, if the developer what's automatic response management.\n  * @return {number} Returns the message ID, in case it should be needed for manual management of the response handler.\n  */\n  postMessage(inMsg, responseCallback) { }\n\n  /**\n   * Not public available, used by the class extension implementation, to process messages from the public \"postMessage\" without a registered listener.\n   * Used to send the message to an external interface, like a WebWorker, IFrame, etc.\n   * @param  {Message.Message} msg Message\n   */\n  _onPostMessage(msg) { /*implementation will send message to external system*/ }\n\n  /**\n   * Not public available, used by the class extension implementation, to process all messages that enter the MiniBus from an external interface, like a WebWorker, IFrame, etc.\n   * This method is called one time in the constructor to register external listeners.\n   * The implementation will probably call the \"_onMessage\" method to publish in the local listeners.\n   * DO NOT call \"postMessage\", there is a danger that the message enters in a cycle!\n   */\n  _registerExternalListener() { /*implementation will register external listener and call \"this._onMessage(msg)\" */ }\n\n}\n\nclass MsgListener {\n  /* private\n  _subscriptions: <string: MsgListener[]>;\n  _url: string;\n  _callback: (msg) => void;\n  */\n\n  constructor(subscriptions, url, callback) {\n    let _this = this;\n\n    _this._subscriptions = subscriptions;\n    _this._url = url;\n    _this._callback = callback;\n  }\n\n  get url() { return this._url; }\n\n  remove() {\n    let _this = this;\n\n    let subs = _this._subscriptions[_this._url];\n    if (subs) {\n      let index = subs.indexOf(_this);\n      subs.splice(index, 1);\n\n      //if there are no listeners, remove the subscription entirely.\n      if (subs.length === 0) {\n        delete _this._subscriptions[_this._url];\n      }\n    }\n  }\n}\n\nexport default Bus;\n","import Bus from './Bus';\n\nclass MiniBus extends Bus {\n\n  constructor() {\n    super();\n  }\n\n  postMessage(inMsg, responseCallback) {\n    let _this = this;\n\n    _this._genId(inMsg);\n    _this._responseCallback(inMsg, responseCallback);\n\n    //always send to external (to core MessageBus)\n    _this._onPostMessage(inMsg);\n\n    return inMsg.id;\n  }\n\n  _onMessage(msg) {\n    let _this = this;\n\n    if (!_this._onResponse(msg)) {\n      let itemList = _this._subscriptions[msg.to];\n      if (itemList) {\n        _this._publishOn(itemList, msg);\n        if (!msg.to.startsWith('hyperty')) {\n          _this._publishOnDefault(msg);\n        }\n      } else {\n        _this._publishOnDefault(msg);\n      }\n    }\n  }\n\n}\n\nexport default MiniBus;\n","import SandboxRegistry from '../sandbox/SandboxRegistry';\nimport MiniBus from '../bus/MiniBus';\n// import MessageFactory from '../../resources/MessageFactory';\n\nexport let SandboxType = {APP: 'app', NORMAL: 'normal'};\n\n/**\n * @author micaelpedrosa@gmail.com\n * Base class to implement external sandbox component\n */\nclass Sandbox extends MiniBus {\n\n  constructor() {\n\n    super();\n\n    let _this = this;\n\n    // Add Message Factory\n    // let messageFactory = new MessageFactory();\n    // _this.messageFactory = messageFactory;\n  }\n\n  /**\n   * Deploy an instance of the component into the sandbox.\n   * @param  {string} componentSourceCode Component source code (Hyperty, ProtoStub, etc)\n   * @param  {URL} componentURL Hyperty, ProtoStub, or any other component address.\n   * @param  {Config} configuration Config parameters of the component\n   * @return {Promise<string>} return deployed if successful, or any other string with an error\n   */\n  deployComponent(componentSourceCode, componentURL, configuration) {\n\n    let _this = this;\n\n    // let messageFactory = _this.messageFactory;\n\n    return new Promise((resolve, reject) => {\n      //TODO: message format is not properly defined yet\n      let deployMessage = {\n        type: 'create', from: SandboxRegistry.ExternalDeployAddress, to: SandboxRegistry.InternalDeployAddress,\n        body: { url: componentURL, sourceCode: componentSourceCode, config: configuration }\n      };\n\n      //send message into the sandbox internals and wait for reply\n      _this.postMessage(deployMessage, (reply) => {\n        if (reply.body.code === 200) {\n          //is this response complaint with the spec?\n          resolve('deployed');\n        } else {\n          reject(reply.body.desc);\n        }\n      });\n    });\n  }\n\n  /**\n   * Remove the instance of a previously deployed component.\n   * @param  {URL} componentURL Hyperty, ProtoStub, or any other component address.\n   * @return {Promise<string>} return undeployed if successful, or any other string with an error\n   */\n  removeComponent(componentURL) {\n    let _this = this;\n\n    return new Promise((resolve, reject) => {\n      //TODO: message format is not properly defined yet\n      let removeMessage = {\n        type: 'delete', from: SandboxRegistry.ExternalDeployAddress, to: SandboxRegistry.InternalDeployAddress,\n        body: { url: componentURL }\n      };\n\n      //send message into the sandbox internals and wait for reply\n      _this.postMessage(removeMessage, (reply) => {\n        if (reply.body.code === 200) {\n          //is this response complaint with the spec?\n          resolve('undeployed');\n        } else {\n          reject(reply.body.desc);\n        }\n      });\n    });\n  }\n}\n\nexport default Sandbox;\n","/**\n * @author micaelpedrosa@gmail.com\n * Base class to implement internal deploy manager of components.\n */\n\n// import MessageFactory from '../../resources/MessageFactory';\n\nclass SandboxRegistry {\n  /* private\n  _components: <url: instance>\n  */\n\n  constructor(bus) {\n    let _this = this;\n\n    _this._bus = bus;\n    _this._components = {};\n\n    // Add Message Factory\n    // let messageFactory = new MessageFactory();\n    // _this.messageFactory = messageFactory;\n\n    bus.addListener(SandboxRegistry.InternalDeployAddress, (msg) => {\n      //console.log('SandboxRegistry-RCV: ', msg);\n      // let responseMsg = {\n      //   id: msg.id, type: 'response', from: SandboxRegistry.InternalDeployAddress, to: SandboxRegistry.ExternalDeployAddress\n      // };\n\n      switch (msg.type) {\n        case 'create': _this._onDeploy(msg); break;\n        case 'delete': _this._onRemove(msg); break;\n      }\n    });\n  }\n\n  get components() { return this._components; }\n\n  _responseMsg(msg, code, value) {\n\n    let _this = this;\n\n    // let messageFactory = _this.messageFactory;\n\n    let responseMsg = {\n      id: msg.id, type: 'response', from: SandboxRegistry.InternalDeployAddress, to: SandboxRegistry.ExternalDeployAddress\n    };\n\n    // Chanege the origin message, because the response;\n    // msg.from = SandboxRegistry.InternalDeployAddress;\n    // msg.to = SandboxRegistry.ExternalDeployAddress;\n\n    let body = {};\n    if (code) body.code = code;\n    if (value) body.desc = value;\n\n    responseMsg.body = body;\n\n    // return messageFactory.createResponse(msg, code, value);\n    return responseMsg;\n  }\n\n  _onDeploy(msg) {\n    let _this = this;\n    let config = msg.body.config;\n    let componentURL = msg.body.url;\n    let sourceCode = msg.body.sourceCode;\n    let responseCode;\n    let responseDesc;\n\n    if (!_this._components.hasOwnProperty(componentURL)) {\n      try {\n        _this._components[componentURL] = _this._create(componentURL, sourceCode, config);\n        responseCode = 200;\n      } catch (error) {\n        responseCode = 500;\n        responseDesc = error;\n      }\n    } else {\n      responseCode = 500;\n      responseDesc = 'Instance ' + componentURL + ' already exist!';\n    }\n\n    // Create response message with MessageFactory\n    let responseMsg = _this._responseMsg(msg, responseCode, responseDesc);\n    _this._bus.postMessage(responseMsg);\n  }\n\n  _onRemove(msg) {\n    let _this = this;\n    let componentURL = msg.body.url;\n    let responseCode;\n    let responseDesc;\n\n    if (_this._components.hasOwnProperty(componentURL)) {\n      //remove component from the pool and all listeners\n      delete _this._components[componentURL];\n      _this._bus.removeAllListenersOf(componentURL);\n      responseCode = 200;\n    } else {\n      responseCode = 500;\n      responseDesc = 'Instance ' + componentURL + ' doesn\\'t exist!';\n    }\n\n    let responseMsg = _this._responseMsg(msg, responseCode, responseDesc);\n\n    _this._bus.postMessage(responseMsg);\n  }\n\n  /**\n   * This method should be implemented by the internal sandbox code.\n   * @param  {ComponentURL} url URL used for the instance\n   * @param  {string} sourceCode Code of the component\n   * @param  {Config} config Configuration parameters\n   * @return {Object} Returns instance of the component or throw an error \"throw 'error message'\"\n   */\n  _create(url, sourceCode, config) {\n    //implementation specific\n    /* example code:\n      eval(sourceCode);\n      return activate(url, _this._bus, config);\n    */\n  }\n}\n\nSandboxRegistry.ExternalDeployAddress = 'hyperty-runtime://sandbox/external';\nSandboxRegistry.InternalDeployAddress = 'hyperty-runtime://sandbox/internal';\n\nexport default SandboxRegistry;\n","/**\n* Copyright 2016 PT Inovação e Sistemas SA\n* Copyright 2016 INESC-ID\n* Copyright 2016 QUOBIS NETWORKS SL\n* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V\n* Copyright 2016 ORANGE SA\n* Copyright 2016 Deutsche Telekom AG\n* Copyright 2016 Apizee\n* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\");\n* you may not use this file except in compliance with the License.\n* You may obtain a copy of the License at\n*\n*   http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing, software\n* distributed under the License is distributed on an \"AS IS\" BASIS,\n* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n* See the License for the specific language governing permissions and\n* limitations under the License.\n**/\nimport Sandbox from 'runtime-core/src/sandbox/Sandbox';\nimport SandboxRegistry from 'runtime-core/src/sandbox/SandboxRegistry';\nimport MiniBus from 'runtime-core/src/bus/MiniBus';\n\nself._miniBus = new MiniBus();\nself._miniBus._onPostMessage = function(msg){\n    self.postMessage(msg);\n};\nself.addEventListener('message', function(event){\n    self._miniBus._onMessage(event.data);\n});\n\nself._registry = new SandboxRegistry(self._miniBus);\nself._registry._create = function(url, sourceCode, config){\n    eval.apply(self, [sourceCode]);\n    return activate(url, self._miniBus, config);\n};\n"],"sourceRoot":"/source/"}